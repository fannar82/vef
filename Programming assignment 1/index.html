<!DOCTYPE html>
<!-- (c) Fannar Már Sigurðsson & Finnbjörn Þorvaldsson -->
<!-- Reykjavik University -->
<!-- WEPO, spring 2013-->
<!-- Programming assignment 1 -->
<html>
<head>
	<script type="text/javascript" src="js/Base.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="css/mainStyle.css" />
	<link rel="stylesheet" type="text/css" href="css/960.css" />
	<link rel="stylesheet" type="text/css" href="css/reset.css" />
	<title>Fannar &amp; Finnbj&ouml;rn WEPO verkefni 1 WhatSlapMeAroundAndColorMePerfect!</title>
</head>
<body>
	<div id="content" class="container_12">
		<div id="head" class="grid_12">
			<img src="img/mathboard.png" />
		</div>
		<div>

		</div>
		<div id="colorPicker" class="grid_12">
			<p id="black">&nbsp;</p>
			<p id="blue">&nbsp;</p>
			<p id="red">&nbsp;</p>
			<p id="green">&nbsp;</p>
			<p>Thickness:
			<select id="selectTickness">
			  <option value="1">1</option>
			  <option value="2">2</option>
			  <option value="3">3</option>
			  <option value="4">4</option>
			  <option value="5">5</option>
			  <option value="9">9</option>
			</select>
			</p>
			<span id="load">Load</span>
			<span id="save">Save</span>
			<span id="rectangle">Rectangle</span>
			<span id="circle">Circle</span>
			<span id="freehand">Freehand</span>
			<span id="line">Line</span>
			<span id="text">Text</span>
			<span id="img">Image</span>
			<!-- Not used in this version
			<span id="watermark">Watermark</span>
			-->
			<span id="undo">Undo</span>
			<span id="clearWB">Clear</span>
		</div>


		<!--Wrapping the canvas in a "useless" DIV,
		    to fix positioning error due to Grid960 -->
		<div class="grid_12">
			<canvas id="drawing-board" width="938px" height="400px">
				<p>Your browser does not support this. Please update your browser and enter the year 2013.</p>
			</canvas>
		<div>
	</div>

	<div id="lower_tools" class="grid_12">
		<span id="prev_wb">Previous</span>
		<span id="next_wb">Next</span>
	</div>

	<div id="info">
		<p>When text is selected, thickness is multiplied by 5 and used as font size.</p>
		<p>Images are not affected by thicness or color.</p>
	</div>
<textarea rows="10" cols="50" id="saveBox"></textarea>
<textarea rows="4" cols="50" id="textinput"></textarea> <!-- The textbox that appers in the canvas -->

<script type="text/javascript">
	
	// A Cursor fix for Chrome:
	document.onselectstart = function(){ 
		return false; 
	};
	
	//Main drawingboard functions.
	var wb = function(){}; // "Whiteboard", the global guy.
		wb.currentShape;
		wb.selectTickness = $("#selectTickness");
		wb.thickness = "1";
		wb.canvas = document.getElementById("drawing-board");
		wb.context = wb.canvas.getContext("2d");
		wb.tool = "rectangle"; // Start up with this shape.
		wb.color = "red"; // Start up with this color.
		wb.shapesArray = new Array(); // Objects put here and removed on undo.
		wb.shapesRedo = new Array(); // Undo actions sent here.
		wb.mouseIsDown = false; // For mouse movements gestures.
		wb.textinput = $("#textinput"); // Fetch the text input field.
		wb.undo = $("#undo"); // Fetch the undo button.
  		wb.mouseCurrX = null; // For moving objects on canvas.
  		wb.mouseCurrY = null; // For moving objects on canvas.
  		wb.margin = 10; // Margin for select.
  		wb.loadArray = [];
	
	// Hide the textarea when page loads
	wb.textinput.hide();
	
	$(wb.canvas).mousedown( function(e) {
		// If Ctrl is pressed, selection is in progress
		// and no shape sholud be drawn.
		if ( e.ctrlKey ) {
			// 1. Finna hvort það sé hlutur í arrayinu sem
			//    er í sama punkti. Þ.e. renna í gegnum arrayið
			//    í öfuga átt og athugað hvort stakið sé á
			//    þeim punkti.

			// Í freehand, það sem er klikkað færðu X og
			// Y gildi sem þú getur borið saman við X og
			// Y gildin sem eru í Point array
			for (var i = 0; i < wb.shapesArray.length; i++) {
		  		wb.shapesArray[i].select( e.pageX, e.pageY, wb.margin );
			}
		}
		else {
			// Set starting point (different shapes might
			// treat "starting point" differently)
			// StartX,Y fixes browser compability
			startX = e.pageX - this.offsetLeft;
			startY = e.pageY - this.offsetTop;

			var trunk = function() {}
				trunk.startX = startX
				trunk.startY = startY;
				trunk.color = wb.color;
				trunk.thickness = wb.thickness;
				trunk.canvas = wb.canvas;
				trunk.tool = wb.tool;

			// Select shape to draw
			// Crockford hatest switch,
			// but we know how to use "break;"
			// so we love it ;-)
			switch (wb.tool) {
				case "rectangle":
					wb.currentShape = new Rectangle( trunk );
					break;
				case "circle":
					wb.currentShape = new Circle( trunk );
					break;
				case "freehand":
					wb.currentShape = new Freehand( trunk );
					break;
				case "line":
					wb.currentShape = new Line( trunk );
					break;
				case "text":
					wb.textinput.show();
					wb.textinput.offset({ left: e.pageX, top: e.pageY });
					wb.textinput.focus();
					wb.currentShape = new Text( trunk );
					break;
				case "img":
					wb.currentShape = new Img( trunk );
					break;
				// Not used in this version
				// case "watermark":
					//wb.currentShape = new Watermark( 0, 0 );
					//break;
			}

			// The mouse has been pressed
			wb.mouseIsDown = true;
		}
	});

	$(wb.canvas).mousemove( function(e) {
		if ( wb.mouseIsDown === true ){
			if( wb.tool === "freehand" ) {
				wb.currentShape.setEnd( e.pageX, e.pageY );
				wb.currentShape.arrayX();
				wb.currentShape.draw();
	  		}
	  	}

	  	// Move selected objects
	  	if ( wb.shapesArray.length > 0 && e.shiftKey ) {
			for (var i = 0; i < wb.shapesArray.length; i++) {
				if ( wb.shapesArray[i].selected === true )
				{
		  			wb.shapesArray[i].move( e.pageX - wb.mouseCurrX, e.pageY - wb.mouseCurrY );
		  		}
			}
			wb.context.clearRect(0, 0, wb.canvas.width, wb.canvas.height);
			redraw(wb.shapesArray);	
	  	}

	  	// Position the mouse for next move.
	  	wb.mouseCurrX = e.pageX;
	  	wb.mouseCurrY = e.pageY;
	});
	
	$(wb.canvas).mouseup( function(e) {
		// If Ctrl is pressed, selection is in progress
		// and no shape sholud be drawn.
		if ( !e.ctrlKey ) {
			wb.currentShape.setEnd( e.pageX, e.pageY );
			wb.currentShape.draw();

			// If this is text, then it should only be
			// added when the textbox retrives an Enter,
			// see "wb.textinput.keypress" function.
			if ( wb.currentShape.iAm != "Text" ) {
				addToShapesArray( wb.currentShape );
			};

			// The mouse is no longer pressed
			wb.mouseIsDown = false;
		}
	});

	// Listener to wb.textinput
	wb.textinput.keypress( function(e) {
		// If Enter is pressed, hide the textarea again
		// and draw it's contents to the canvas.
    	if(e.keyCode === 13 && !e.shiftKey){
    		wb.currentShape.drawText( wb.textinput.val() );
    		wb.textinput.hide();
    		wb.textinput.val(''); // Clear textarea for next use
    		console.log("Enter has been pressed.");

    		addToShapesArray( wb.currentShape );
      	}
	});

	$(wb.undo).click( function() {
		makeUndo();
	});

	$(document).keypress( function(e) {
		// If the textinput object is not loaded and 
		// Ctrl + Z is pressed - undo last action.
		// Works like a charm in Chrome, does not work in FireFox.
		if ( wb.tool != "text" ) {
			if( e.which === 26 && e.ctrlKey ){
				makeUndo( );
			}
		}
	});

	function addToShapesArray ( shape ) {
		// Push the shape to the array for later usage
		wb.shapesArray.push(wb.currentShape);
		console.log( "A shape was added to wb.shapesArray, current count: " + wb.shapesArray.length );
		console.log( "List of all shapes: " + wb.shapesArray.toString() );
	}

	function makeUndo () {
		console.log("Starting undo.");

		wb.context.clearRect(0, 0, wb.canvas.width, wb.canvas.height);
		wb.shapesRedo.push(wb.shapesArray.pop());
		redraw(wb.shapesArray);

		console.log("Undo done.");
	}
</script>
<script type="text/javascript" src="js/tools.js"></script>
<script type="text/javascript" src="js/shape.js"></script>
<script type="text/javascript" src="js/circle.js"></script>
<script type="text/javascript" src="js/rect.js"></script>
<script type="text/javascript" src="js/freehand.js"></script>
<script type="text/javascript" src="js/line.js"></script>
<script type="text/javascript" src="js/text.js"></script>
<script type="text/javascript" src="js/img.js"></script>
<script type="text/javascript" src="js/redraw.js"></script>
<script type="text/javascript" src="js/Point.js"></script>
<script type="text/javascript" src="js/saveDrawing.js"></script>
<script type="text/javascript" src="js/json2.js"></script> <!-- Written by Douglas Crockford  // https://github.com/douglascrockford/JSON-js/blob/master/json2.js // im surly going to use 
this for my evil dooing. -->


<!--Not used in this vesion
	<script type="text/javascript" src="js/watermark.js"></script>
-->
</body>
</html>