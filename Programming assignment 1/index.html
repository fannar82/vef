<!DOCTYPE html>
<!-- (c) Fannar Már Sigurðsson & Finnbjörn Þorvaldsson -->
<!-- Reykjavik University -->
<!-- WEPO, spring 2013-->
<!-- Programming assignment 1 -->
<html>
<head>
	<script type="text/javascript" src="js/Base.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="css/mainStyle.css" />
	<link rel="stylesheet" type="text/css" href="css/960.css" />
	<link rel="stylesheet" type="text/css" href="css/reset.css" />
	<title>Fannar &amp; Finnbj&ouml;rn WEPO verkefni 1 WhatSlapMeAroundAndColorMePerfect!</title>
</head>
<body>

	<div id="content" class="container_12">
		<div id="head" class="grid_12">
			<img src="img/mathboard.png" />
		</div>
		<div id="colorPicker" class="grid_12">
			<p id="black">&nbsp;</p>
			<p id="blue">&nbsp;</p>
			<p id="red">&nbsp;</p>
			<p id="green">&nbsp;</p>
			<span id="rectangle">Rectangle</span>
			<span id="circle">Circle</span>
			<span id="freehand">Freehand</span>
			<span id="line">Line</span>
			<span id="text">Text</span>
			<span id="img">Image</span>
			<span id="watermark">Watermark</span>
			<span id="undo">Undo</span>
		</div>


		<!--Wrapping the canvas in a useless DIV,
		    to fix positioning error due to Grid960 -->
		<div class="grid_12">
			<canvas id="drawing-board" width="938px" height="400px">
				<p>
					Your browser does not support this. Please update your browser and enter the year 2013.
				</p>
			</canvas>
		<div>
	</div>

<textarea rows="4" cols="50" id="textinput"></textarea>

<script type="text/javascript">
	
	// A Cursor fix for Chrome:
	document.onselectstart = function(){ 
		return false; 
	};
	
	//Main drawingboard functions.
	var currentShape;
	var canvas = document.getElementById("drawing-board");
	var context = canvas.getContext("2d");
	var tool = "rectangle"; // Start up with this shape.
	var color = "red"; // Start up with this color.
	var shapesArray = new Array(); // Objects put here and removed on undo.
	var shapesRedo = new Array(); // Undo actions sent here.
	var mouseIsDown = false; // For mouse movements gestures.
	var textinput = $("#textinput"); // Fetch the text input field.
	var undo = $("#undo"); // Fetch the undo button.
  	var mouseCurrX = null; // For moving objects on canvas.
  	var mouseCurrY = null; // For moving objects on canvas.
  	var margin = 3; // Margin for select.
	
	// Hide the textarea when page loads
	textinput.hide();
	
	$(canvas).mousedown( function(e) {
		// If Ctrl is pressed, selection is in progress
		// and no shape sholud be drawn.
		if ( e.ctrlKey ) {
			// 1. Finna hvort það sé hlutur í arrayinu sem
			//    er í sama punkti. Þ.e. renna í gegnum arrayið
			//    í öfuga átt og athugað hvort stakið sé á
			//    þeim punkti.

			// Í freehand, það sem er klikkað færðu X og
			// Y gildi sem þú getur borið saman við X og
			// Y gildin sem eru í Point array
			for (var i = 0; i < shapesArray.length; i++) {
		  		shapesArray[i].select( e.pageX, e.pageY, margin );
			}
		}
		else {
			// Set starting point (different shapes might
			// treat "starting point" differently)
			// StartX,Y fixes browser compability
			startX = e.pageX - this.offsetLeft;
			startY = e.pageY - this.offsetTop;

			// Select shape to draw
			switch (tool) {
				case "rectangle":
					currentShape = new Rectangle( startX, startY );
					break;
				case "circle":
					currentShape = new Circle( startX, startY );
					break;
				case "freehand":
					currentShape = new Freehand( startX, startY );
					break;
				case "line":
					currentShape = new Line( startX, startY );
					break;
				case "text":
					textinput.show();
					textinput.offset({ left: e.pageX, top: e.pageY });
					textinput.focus();
					currentShape = new Text( startX, startY );
					break;
				case "img":
					currentShape = new Img( startX, startY );
					break;
				case "watermark":
					currentShape = new Watermark( 0, 0 );
					break;
			}

			// The mouse has been pressed
			mouseIsDown = true;
		}
	});

	$(canvas).mousemove( function(e) {
		if ( mouseIsDown == true ){
			if( tool == "freehand" ) {
				currentShape.setEnd( e.pageX, e.pageY );
				currentShape.arrayX();
				currentShape.draw();
	  		}
	  	}

	  	// Move selected objects
	  	if ( shapesArray.length > 0 && e.shiftKey ) {
  			var length = shapesArray.length;
			for (var i = 0; i < length; i++) {
				if ( shapesArray[i].selected == true )
				{
		  			shapesArray[i].move( e.pageX - this.mouseCurrX, e.pageY - this.mouseCurrY );
		  		}
			}
			context.clearRect(0, 0, canvas.width, canvas.height);
			redraw(shapesArray);
	  	}

	  	// Position the mouse for next move.
	  	this.mouseCurrX = e.pageX;
	  	this.mouseCurrY = e.pageY;
	});
	
	$(canvas).mouseup( function(e) {
		// If Ctrl is pressed, selection is in progress
		// and no shape sholud be drawn.
		if ( !e.ctrlKey ) {
			currentShape.setEnd( e.pageX, e.pageY );
			currentShape.draw();

			// If this is text, then it should only be
			// added when the textbox retrives an Enter,
			// see "textinput.keypress" function.
			if ( currentShape.iAm != "Text" ) {
				addToShapesArray( currentShape );
			};

			// The mouse is no longer pressed
			mouseIsDown = false;
		}

	});

	// Listener to textinput
	textinput.keypress( function(e) {

		// If Enter is pressed, hide the textarea again
		// and draw it's contents to the canvas.
    	if(e.keyCode == 13 && !e.shiftKey){
    		currentShape.drawText( textinput.val() );
    		textinput.hide();
    		textinput.val(''); // Clear textarea for next use
    		console.log("Enter has been pressed.");

    		addToShapesArray( currentShape );
      	}
	});

	$(undo).click( function() {
		makeUndo();
	});

	$(document).keypress( function(e) {
		// If the textinput object is not loaded and 
		// Ctrl + Z is pressed - undo last action.
		if ( tool != "text" ) {
			if( e.which === 26 && e.ctrlKey ){
				makeUndo( );
			}
		}
	});

	function addToShapesArray ( shape ) {
		// Push the shape to the array for later usage
		shapesArray.push(currentShape);
		console.log( "A shape was added to shapesArray, current count: " + shapesArray.length );
		console.log( "List of all shapes: " + shapesArray.toString() );
	}

	function makeUndo () {
		console.log("Starting undo.");

		context.clearRect(0, 0, canvas.width, canvas.height);
		shapesRedo.push(shapesArray.pop());
		redraw(shapesArray);

		console.log("Undo done.");
	}


</script>
<script type="text/javascript" src="js/color.js"></script>
<script type="text/javascript" src="js/shape.js"></script>
<script type="text/javascript" src="js/circle.js"></script>
<script type="text/javascript" src="js/rect.js"></script>
<script type="text/javascript" src="js/freehand.js"></script>
<script type="text/javascript" src="js/line.js"></script>
<script type="text/javascript" src="js/text.js"></script>
<script type="text/javascript" src="js/img.js"></script>
<script type="text/javascript" src="js/watermark.js"></script>
<script type="text/javascript" src="js/redraw.js"></script>
<script type="text/javascript" src="js/Point.js"></script>
</body>
</html>